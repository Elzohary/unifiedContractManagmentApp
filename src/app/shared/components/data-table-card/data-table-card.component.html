<div class="data-table-card mat-elevation-z2">
  <!-- Title if provided and enabled -->
  <h2 *ngIf="title && showTitle" class="table-title mat-headline-6">{{ title }}</h2>

  <!-- Filter tabs -->
  <div *ngIf="showFilters && filters && filters.length > 0" class="filters-tabs">
    <mat-tab-group
      (selectedTabChange)="onFilterTabChange($event)"
      [selectedIndex]="selectedFilterIndex"
      aria-label="Filter options">
      <mat-tab *ngFor="let filter of filters" [label]="filter.label"></mat-tab>
    </mat-tab-group>
    <mat-divider></mat-divider>
  </div>

  <!-- Search input -->
  <div *ngIf="showSearch" class="search-container">
    <mat-form-field appearance="outline">
      <mat-label>Filter</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Search..." aria-label="Search input">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading && showLoadingState" class="state-container loading-container">
    <mat-spinner [diameter]="loadingState.spinnerDiameter" color="primary"></mat-spinner>
    <p>{{ loadingState.message }}</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && showErrorState && !loading" class="state-container error-container">
    <mat-icon class="error-icon mat-warn" aria-hidden="true">{{ errorState.icon }}</mat-icon>
    <h2>{{ errorState.title }}</h2>
    <p>{{ errorState.message }}</p>
    <button
      *ngIf="errorState.buttonLabel"
      mat-raised-button
      color="warn"
      (click)="onStateAction('error', errorState.buttonAction)">
      {{ errorState.buttonLabel }}
    </button>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && !error && showEmptyState && dataSource.data.length === 0" class="state-container empty-container">
    <mat-icon class="empty-icon" aria-hidden="true">{{ emptyState.icon }}</mat-icon>
    <h2>{{ emptyState.title }}</h2>
    <p>{{ emptyState.message }}</p>
    <button
      *ngIf="emptyState.buttonLabel"
      mat-raised-button
      color="primary"
      (click)="onStateAction('empty', emptyState.buttonAction ?? '')">
      {{ emptyState.buttonLabel }}
    </button>
  </div>

  <!-- Data table -->
  <div
    class="table-container"
    *ngIf="!loading && !error && dataSource.data.length > 0">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      class="data-table mat-elevation-z0"
      [class.with-hover]="hoverEffect">

      <!-- Dynamic columns based on configuration -->
      <ng-container *ngFor="let column of columns" [matColumnDef]="column.property">
        <th
          mat-header-cell
          *matHeaderCellDef
          [mat-sort-header]="column.sortable ? column.property : ''"
          [style.width]="column.width"
          [ngClass]="column.class">
          {{ column.header }}
        </th>
        <td
          mat-cell
          *matCellDef="let item"
          [ngClass]="column.class"
          [ngStyle]="column.style">

          <!-- Use custom template if specified -->
          <ng-container *ngIf="column.customTemplate && customTemplates">
            <ng-container *ngTemplateOutlet="customTemplates | getTemplateByName:column.customTemplate; context: {$implicit: item, column: column}"></ng-container>
          </ng-container>

          <!-- Default display -->
          <ng-container *ngIf="!column.customTemplate">
            {{ getDisplayValue(column, item) }}
          </ng-container>
        </td>
      </ng-container>

      <!-- Actions column -->
      <ng-container *ngIf="actions && actions.length > 0" matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="actions-cell">Actions</th>
        <td mat-cell *matCellDef="let row" class="actions-cell">
          <button mat-icon-button [matMenuTriggerFor]="actionsMenu" aria-label="Row actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #actionsMenu="matMenu">
            <ng-container *ngFor="let action of actions">
              <button
                mat-menu-item
                *ngIf="!action.showFn || action.showFn(row)"
                [disabled]="action.disableFn && action.disableFn(row)"
                [ngClass]="[action.class || '', action.color ? 'menu-item-' + action.color : '']"
                (click)="onRowAction(action.action, row)">
                <mat-icon *ngIf="action.icon">{{action.icon}}</mat-icon>
                <span>{{action.label}}</span>
              </button>
            </ng-container>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns;"
        (click)="onRowClick(row)"
        [class.clickable]="hoverEffect"
        tabindex="0">
      </tr>
    </table>

    <!-- Pagination -->
    <mat-paginator
      *ngIf="showPagination"
      [pageSizeOptions]="pageSizeOptions"
      [pageSize]="pageSize"
      aria-label="Select page">
    </mat-paginator>
  </div>
</div>
